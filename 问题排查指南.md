# 问题排查指南

## 问题 1：显示"本地模式"而不是"云端数据库"

### 原因
API 调用失败（`/api/teams` 或 `/api/announcement`），应用自动回退到 localStorage。

### 排查步骤

1. **检查浏览器控制台**
   - 打开开发者工具（F12）
   - 查看 Console 标签页
   - 找到错误信息（通常是红色的）

2. **检查 Vercel 环境变量**
   - 登录 Vercel Dashboard
   - 进入项目 → Settings → Environment Variables
   - 确认以下变量已配置：
     - `DATABASE_URL` - PostgreSQL 连接字符串
     - `BLOB_READ_WRITE_TOKEN` - Vercel Blob 访问令牌

3. **检查 Vercel Functions 日志**
   - Vercel Dashboard → 项目 → Deployments
   - 点击最新的部署
   - 查看 Functions 标签页，检查是否有错误日志

4. **测试 API 端点**
   - 直接访问：`https://你的域名/api/teams`
   - 应该返回 JSON 数据
   - 如果返回错误，查看错误信息

### 解决方案

如果环境变量缺失：
```bash
# 在 Vercel Dashboard 中添加：
DATABASE_URL=postgresql://...
BLOB_READ_WRITE_TOKEN=vercel_blob_xxx...
```

如果 API 返回 500 错误：
- 检查数据库连接是否正常
- 检查数据库表是否存在
- 查看 Vercel Functions 日志获取详细错误

---

## 问题 2：上传失败（作品/封面图）

### 原因 A：数据库字段缺失

**症状：**
- 上传时提示"数据库需要更新"
- 错误信息包含 "unfinished_works" 或 "finished_works"

**解决方案：**
在 Vercel Postgres 控制台执行以下 SQL：

```sql
ALTER TABLE teams 
ADD COLUMN IF NOT EXISTS unfinished_works JSONB DEFAULT '[]',
ADD COLUMN IF NOT EXISTS finished_works JSONB DEFAULT '[]';
```

**执行步骤：**
1. 登录 Vercel Dashboard
2. 进入项目 → Storage → Postgres
3. 点击 "SQL Editor"
4. 粘贴上面的 SQL
5. 点击 "Run"

### 原因 B：Vercel Blob 配置问题

**症状：**
- 上传时提示"上传初始化失败"
- 错误信息包含 "BLOB_READ_WRITE_TOKEN"

**解决方案：**
1. 在 Vercel Dashboard 添加环境变量：
   - `BLOB_READ_WRITE_TOKEN`（从 Vercel Blob 设置中获取）

2. 重新部署项目（添加环境变量后需要重新部署）

### 原因 C：网络连接问题

**症状：**
- 上传时提示"网络连接失败"
- 错误信息包含 "Failed to fetch" 或 "NetworkError"

**解决方案：**
1. 检查网络连接
2. 检查浏览器控制台的网络请求
3. 确认 `/api/upload` 端点是否可访问

---

## 快速诊断命令

### 在浏览器控制台执行：

```javascript
// 测试 API 是否可用
fetch('/api/teams')
  .then(r => r.json())
  .then(d => console.log('✅ Teams API:', d))
  .catch(e => console.error('❌ Teams API 失败:', e));

fetch('/api/announcement')
  .then(r => r.json())
  .then(d => console.log('✅ Announcement API:', d))
  .catch(e => console.error('❌ Announcement API 失败:', e));
```

### 检查当前模式：

```javascript
// 在浏览器控制台查看 localStorage
console.log('当前存储的数据:', localStorage.getItem('personnel_structure_v16_final_fix'));
```

---

## 常见错误代码对照

| 错误信息 | 可能原因 | 解决方案 |
|---------|---------|---------|
| "Failed to fetch" | 网络问题或 API 未部署 | 检查网络，确认 API 端点可访问 |
| "column does not exist" | 数据库字段缺失 | 运行迁移脚本 |
| "BLOB_READ_WRITE_TOKEN" | Blob 令牌缺失 | 添加环境变量并重新部署 |
| "relation does not exist" | 数据库表不存在 | 运行初始化脚本 `lib/init-db.sql` |
| "localStorage" 模式 | API 调用失败 | 检查上述所有配置 |

---

## 完整检查清单

- [ ] Vercel 环境变量 `DATABASE_URL` 已配置
- [ ] Vercel 环境变量 `BLOB_READ_WRITE_TOKEN` 已配置
- [ ] 数据库表已创建（运行了 `lib/init-db.sql`）
- [ ] 数据库字段已更新（运行了 `lib/migration-add-works.sql`）
- [ ] 项目已重新部署（添加环境变量后）
- [ ] API 端点可访问（`/api/teams`, `/api/announcement`, `/api/upload`）
- [ ] 浏览器控制台无错误信息


