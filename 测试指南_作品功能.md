# 作品功能测试指南

## 一、数据库迁移（重要！）

如果数据库已经存在，**必须先执行数据库迁移**才能保存作品数据。

### 在 Vercel Postgres 控制台执行：

1. 登录 [Vercel Dashboard](https://vercel.com/dashboard)
2. 选择你的项目
3. 进入 **Storage** → **Postgres**
4. 点击 **Query** 标签
5. 执行以下 SQL：

```sql
ALTER TABLE teams 
ADD COLUMN IF NOT EXISTS unfinished_works JSONB DEFAULT '[]',
ADD COLUMN IF NOT EXISTS finished_works JSONB DEFAULT '[]';
```

6. 点击 **Run** 执行

### 验证迁移是否成功：

执行以下查询，确认新字段已添加：

```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'teams' 
AND column_name IN ('unfinished_works', 'finished_works');
```

应该能看到两个 JSONB 类型的字段。

---

## 二、本地测试步骤

### 1. 启动开发服务器

如果还没启动，运行：
```bash
npm run dev
```

然后在浏览器打开：`http://localhost:5173`

### 2. 解锁组权限

- 输入管理员密码 `2468` 解锁所有组
- 或者输入单个组的密码解锁特定组

### 3. 测试未完成作品

1. **找到作品区域**
   - 在每组卡片的"账号支出"下方
   - 找到"未完成作品"卡片

2. **悬停显示面板**
   - 将鼠标移动到"未完成作品"卡片上
   - 应该会显示一个悬浮面板

3. **上传作品**
   - 在悬浮面板中点击蓝色 **+** 按钮
   - 选择一张图片文件
   - 图片应该自动压缩并上传
   - 上传后在面板中显示缩略图

4. **删除作品**
   - 将鼠标移动到已上传的图片上
   - 右上角应该出现红色垃圾桶图标
   - 点击垃圾桶删除图片

### 4. 测试已完成作品

重复上述步骤，测试"已完成作品"功能。

### 5. 检查数据持久化

1. **刷新页面**
   - 按 F5 刷新浏览器
   - 之前上传的作品应该仍然显示

2. **检查控制台**
   - 打开浏览器开发者工具（F12）
   - 查看 Console 标签
   - 应该看到 `✅ 作品已上传` 或 `✅ 作品已删除` 的日志

3. **检查数据库**（如果使用云端数据库）
   - 在 Vercel Postgres 中执行：
   ```sql
   SELECT id, title, unfinished_works, finished_works 
   FROM teams 
   WHERE unfinished_works != '[]'::jsonb 
   OR finished_works != '[]'::jsonb;
   ```
   - 应该能看到上传的作品 URL 数组

---

## 三、生产环境测试

### 1. 部署到 Vercel

```bash
# 提交更改
git add .
git commit -m "feat: 添加未完成/已完成作品功能"
git push origin main
```

Vercel 会自动部署。

### 2. 等待部署完成

- 在 Vercel Dashboard 查看部署状态
- 等待部署完成（通常 1-2 分钟）

### 3. 访问生产环境

- 访问你的域名（如 `jubianage.cn`）
- 重复上述测试步骤

### 4. 验证功能

- ✅ 悬停显示面板
- ✅ 上传图片（自动压缩）
- ✅ 删除图片
- ✅ 数据持久化（刷新后仍存在）
- ✅ 图片以缩略图形式显示（约 300x300px）

---

## 四、常见问题排查

### 问题1：上传后图片不显示

**可能原因：**
- 数据库字段未添加（需要执行迁移）
- 网络问题导致上传失败

**解决方法：**
1. 检查浏览器控制台错误信息
2. 确认数据库迁移已执行
3. 检查网络连接

### 问题2：删除后图片仍在

**可能原因：**
- Blob 存储删除失败（不影响功能）
- 数据库更新失败

**解决方法：**
1. 刷新页面查看实际状态
2. 检查控制台日志
3. 如果数据库更新失败，会显示提示信息

### 问题3：悬停面板不显示

**可能原因：**
- 浏览器兼容性问题
- CSS 样式冲突

**解决方法：**
1. 尝试清除浏览器缓存
2. 检查浏览器控制台是否有错误
3. 确保鼠标确实悬停在卡片上（需要停留一下）

### 问题4：图片上传失败

**可能原因：**
- Vercel Blob 存储未配置
- 文件过大（虽然已压缩，但原图过大可能仍有问题）

**解决方法：**
1. 检查 Vercel 环境变量 `BLOB_READ_WRITE_TOKEN` 是否配置
2. 尝试上传较小的图片（< 5MB）
3. 查看控制台错误信息

---

## 五、功能特点验证清单

- [ ] 悬停显示面板（未完成作品）
- [ ] 悬停显示面板（已完成作品）
- [ ] 上传功能（+ 按钮）
- [ ] 图片自动压缩为缩略图
- [ ] 图片网格显示（3列）
- [ ] 删除功能（红色垃圾桶）
- [ ] 删除按钮仅在悬停时显示
- [ ] 数据持久化（刷新后保留）
- [ ] 未解锁时不显示上传按钮
- [ ] 作品数量显示在标题旁

---

## 六、性能检查

1. **图片大小**
   - 上传后检查图片 URL
   - 图片应该已压缩（查看图片属性中的尺寸）
   - 通常在 300x300px 左右

2. **加载速度**
   - 缩略图应该快速加载
   - 面板打开应该流畅无延迟

3. **存储空间**
   - 缩略图大小通常 < 50KB
   - 相比原图节省大量存储空间

---

测试完成后，如果发现任何问题，请告诉我！



